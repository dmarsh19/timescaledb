-- This file and its contents are licensed under the Apache License 2.0.
-- Please see the included NOTICE for copyright information and
-- LICENSE-APACHE for a copy of the license.
SELECT * FROM timescaledb_information.hypertable;
 table_schema | table_name | table_owner | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------+----------------+------------+------------+------------+------------+------------
(0 rows)

-- create simple hypertable with 1 chunk
CREATE TABLE ht1(time TIMESTAMPTZ NOT NULL);
SELECT create_hypertable('ht1','time');
 create_hypertable 
-------------------
 (1,public,ht1,t)
(1 row)

INSERT INTO ht1 SELECT '2000-01-01'::TIMESTAMPTZ;
-- create simple hypertable with 1 chunk and toasted data
CREATE TABLE ht2(time TIMESTAMPTZ NOT NULL, data TEXT);
SELECT create_hypertable('ht2','time');
 create_hypertable 
-------------------
 (2,public,ht2,t)
(1 row)

INSERT INTO ht2 SELECT '2000-01-01'::TIMESTAMPTZ, repeat('8k',4096);
SELECT * FROM timescaledb_information.hypertable ORDER BY table_schema, table_name;
 table_schema | table_name |    table_owner    | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------------+----------------+------------+------------+------------+------------+------------
 public       | ht1        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      |            | 24 kB
 public       | ht2        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      | 8192 bytes | 32 kB
(2 rows)

\c :TEST_DBNAME :ROLE_SUPERUSER
-- create schema open and hypertable with 3 chunks
CREATE SCHEMA open;
GRANT USAGE ON SCHEMA open TO :ROLE_DEFAULT_PERM_USER;
CREATE TABLE open.open_ht(time TIMESTAMPTZ NOT NULL);
SELECT create_hypertable('open.open_ht','time');
 create_hypertable  
--------------------
 (3,open,open_ht,t)
(1 row)

INSERT INTO open.open_ht SELECT '2000-01-01'::TIMESTAMPTZ;
INSERT INTO open.open_ht SELECT '2001-01-01'::TIMESTAMPTZ;
INSERT INTO open.open_ht SELECT '2002-01-01'::TIMESTAMPTZ;
-- create schema closed and hypertable
CREATE SCHEMA closed;
CREATE TABLE closed.closed_ht(time TIMESTAMPTZ NOT NULL);
SELECT create_hypertable('closed.closed_ht','time');
   create_hypertable    
------------------------
 (4,closed,closed_ht,t)
(1 row)

INSERT INTO closed.closed_ht SELECT '2000-01-01'::TIMESTAMPTZ;
SELECT * FROM timescaledb_information.hypertable ORDER BY table_schema, table_name;
 table_schema | table_name |    table_owner    | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------------+----------------+------------+------------+------------+------------+------------
 closed       | closed_ht  | super_user        |              1 |          1 | 8192 bytes | 16 kB      |            | 24 kB
 open         | open_ht    | super_user        |              1 |          3 | 24 kB      | 48 kB      |            | 72 kB
 public       | ht1        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      |            | 24 kB
 public       | ht2        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      | 8192 bytes | 32 kB
(4 rows)

\c :TEST_DBNAME :ROLE_DEFAULT_PERM_USER
SELECT * FROM timescaledb_information.hypertable ORDER BY table_schema,table_name;
 table_schema | table_name |    table_owner    | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------------+----------------+------------+------------+------------+------------+------------
 closed       | closed_ht  | super_user        |              1 |          1 |            |            |            | 
 open         | open_ht    | super_user        |              1 |          3 | 24 kB      | 48 kB      |            | 72 kB
 public       | ht1        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      |            | 24 kB
 public       | ht2        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      | 8192 bytes | 32 kB
(4 rows)

-- filter by schema
SELECT * FROM timescaledb_information.hypertable WHERE table_schema = 'closed' ORDER BY table_schema, table_name;
 table_schema | table_name | table_owner | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------+----------------+------------+------------+------------+------------+------------
 closed       | closed_ht  | super_user  |              1 |          1 |            |            |            | 
(1 row)

-- filter by table name
SELECT * FROM timescaledb_information.hypertable WHERE table_name = 'ht1' ORDER BY table_schema, table_name;
 table_schema | table_name |    table_owner    | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------------+----------------+------------+------------+------------+------------+------------
 public       | ht1        | default_perm_user |              1 |          1 | 8192 bytes | 16 kB      |            | 24 kB
(1 row)

-- filter by owner
SELECT * FROM timescaledb_information.hypertable WHERE table_owner = 'super_user' ORDER BY table_schema,table_name;
 table_schema | table_name | table_owner | num_dimensions | num_chunks | table_size | index_size | toast_size | total_size 
--------------+------------+-------------+----------------+------------+------------+------------+------------+------------
 closed       | closed_ht  | super_user  |              1 |          1 |            |            |            | 
 open         | open_ht    | super_user  |              1 |          3 | 24 kB      | 48 kB      |            | 72 kB
(2 rows)

-- create hypertable with 2 chunks
CREATE TABLE ht5(time TIMESTAMPTZ NOT NULL);
SELECT create_hypertable('ht5','time');
 create_hypertable 
-------------------
 (5,public,ht5,t)
(1 row)

INSERT INTO ht5 SELECT '2000-01-01'::TIMESTAMPTZ;
INSERT INTO ht5 SELECT '2001-01-01'::TIMESTAMPTZ;
-- compressed_chunk_stats should not show dropped chunks
ALTER TABLE ht5 SET (timescaledb.compress);
SELECT compress_chunk(i) FROM show_chunks('ht5') i;
             compress_chunk             
----------------------------------------
 _timescaledb_internal._hyper_5_7_chunk
 _timescaledb_internal._hyper_5_8_chunk
(2 rows)

SELECT drop_chunks(table_name => 'ht5', newer_than => '2000-01-01'::TIMESTAMPTZ);
              drop_chunks               
----------------------------------------
 _timescaledb_internal._hyper_5_8_chunk
(1 row)

SELECT * FROM timescaledb_information.compressed_chunk_stats;
 hypertable_name |               chunk_name               | compression_status | uncompressed_heap_bytes | uncompressed_index_bytes | uncompressed_toast_bytes | uncompressed_total_bytes | compressed_heap_bytes | compressed_index_bytes | compressed_toast_bytes | compressed_total_bytes 
-----------------+----------------------------------------+--------------------+-------------------------+--------------------------+--------------------------+--------------------------+-----------------------+------------------------+------------------------+------------------------
 ht5             | _timescaledb_internal._hyper_5_7_chunk | Compressed         | 8192 bytes              | 16 kB                    | 0 bytes                  | 24 kB                    | 8192 bytes            | 0 bytes                | 8192 bytes             | 16 kB
(1 row)

